# AI 分析方案

## 一、AI 分析架构

### 1.1 整体流程
```
错误上报 → 数据入库 → 触发分析 → AI 处理 → 结果存储 → 前端展示
```

### 1.2 核心组件
- **AI 服务层**：调用 AI API
- **向量数据库**：存储错误向量
- **相似度检索**：查找历史相似错误
- **结果缓存**：复用分析结果

## 二、AI 模型选择

### 2.1 主要选项

#### OpenAI GPT-4
- **优势**：理解能力强，代码分析准确
- **成本**：$0.03/1K tokens (input)
- **适用场景**：复杂错误分析

#### Anthropic Claude
- **优势**：上下文长度大（200K tokens）
- **成本**：$0.008/1K tokens (input)
- **适用场景**：大量堆栈信息分析

#### 本地模型（可选）
- **优势**：成本低，数据私密
- **劣势**：效果较弱，需要 GPU
- **适用场景**：简单错误分类

### 2.2 推荐方案
- **主力**：Claude API（性价比高）
- **备选**：GPT-4（复杂场景）
- **降级**：本地模型（成本控制）

## 三、错误分析功能

### 3.1 错误分类

#### 自动分类
```typescript
enum ErrorCategory {
  SYNTAX_ERROR = '语法错误',
  RUNTIME_ERROR = '运行时错误',
  NETWORK_ERROR = '网络错误',
  RESOURCE_ERROR = '资源加载错误',
  PROMISE_ERROR = 'Promise 错误',
  UNKNOWN = '未知错误'
}
```

#### 分类逻辑
- 基于错误类型（TypeError、ReferenceError）
- 基于错误信息关键词
- AI 辅助分类（不确定时）

### 3.2 根因分析

#### Prompt 设计
```typescript
const analyzePrompt = `
你是一个前端错误分析专家。请分析以下错误信息：

错误类型：${error.type}
错误信息：${error.message}
错误堆栈：
${error.stack}

用户环境：
- 浏览器：${error.browser}
- 操作系统：${error.os}
- 页面 URL：${error.url}

请提供：
1. 错误根本原因（2-3 句话）
2. 可能的触发条件
3. 影响范围评估
4. 修复建议（具体代码示例）
5. 预防措施

请用中文回答，格式化为 JSON。
`
```

#### 返回格式
```typescript
interface AIAnalysisResult {
  rootCause: string          // 根本原因
  triggerConditions: string[] // 触发条件
  impact: 'low' | 'medium' | 'high' // 影响程度
  solution: {
    description: string      // 修复说明
    code: string            // 代码示例
  }
  prevention: string[]       // 预防措施
  confidence: number         // 置信度 0-1
}
```

### 3.3 修复建议

#### 代码级建议
```typescript
// 示例：修复 undefined 错误
{
  before: `
    const value = obj.data.value
  `,
  after: `
    const value = obj?.data?.value ?? defaultValue
  `,
  explanation: '使用可选链和空值合并运算符避免访问 undefined'
}
```

#### 架构级建议
- 添加错误边界
- 增加参数校验
- 优化异步处理

## 四、相似错误检索

### 4.1 向量化方案

#### Embedding 模型
- **OpenAI text-embedding-3-small**
  - 维度：1536
  - 成本：$0.00002/1K tokens
- **本地模型**：sentence-transformers

#### 向量化内容
```typescript
const errorText = `
错误类型：${error.type}
错误信息：${error.message}
文件路径：${error.file}
代码行号：${error.line}
`
```

### 4.2 向量数据库选择

#### Pinecone（推荐）
```typescript
// 配置
{
  dimension: 1536,
  metric: 'cosine',
  pods: 1,
  replicas: 1
}

// 存储
await index.upsert([{
  id: errorId,
  values: embedding,
  metadata: {
    errorType: error.type,
    message: error.message,
    timestamp: error.timestamp
  }
}])

// 检索
const results = await index.query({
  vector: queryEmbedding,
  topK: 5,
  includeMetadata: true
})
```

#### Qdrant（开源替代）
- 支持本地部署
- 性能优秀
- 免费使用

### 4.3 相似度匹配

#### 匹配策略
```typescript
// 相似度阈值
const SIMILARITY_THRESHOLD = 0.85

// 匹配逻辑
if (similarity > SIMILARITY_THRESHOLD) {
  // 复用历史分析结果
  return cachedAnalysis
} else {
  // 调用 AI 重新分析
  return await analyzeWithAI(error)
}
```

#### 聚合相似错误
- 自动合并相似错误
- 统计发生次数
- 优先分析高频错误

## 五、成本优化

### 5.1 分析触发条件

#### 智能触发
```typescript
const shouldAnalyze = (error: Error) => {
  // 1. 新错误必须分析
  if (error.isNew) return true

  // 2. 高频错误（发生 5 次以上）
  if (error.count >= 5) return true

  // 3. 影响用户数多（10 个以上）
  if (error.affectedUsers >= 10) return true

  // 4. 相似度低（找不到历史记录）
  if (error.similarity < 0.7) return true

  return false
}
```

### 5.2 缓存策略

#### 多级缓存
```typescript
// L1: 内存缓存（热点数据）
const memoryCache = new LRU({ max: 1000 })

// L2: Redis 缓存（1 小时）
const redisCache = {
  ttl: 3600,
  key: `ai:analysis:${errorHash}`
}

// L3: 向量检索（相似错误）
const vectorSearch = async (embedding) => {
  return await pinecone.query({ vector: embedding })
}
```

### 5.3 成本预估

#### 月度成本（1000 万 PV）
```
假设：
- 错误率：0.1%（10,000 个错误）
- 需要 AI 分析：20%（2,000 个）
- 平均 tokens：2000 input + 500 output

Claude API 成本：
- Input: 2000 * 2000 * $0.008 / 1000 = $32
- Output: 2000 * 500 * $0.024 / 1000 = $24
- 总计：$56/月

Embedding 成本：
- 10,000 * 200 * $0.00002 / 1000 = $0.04/月

向量数据库（Pinecone）：
- Starter Plan: $70/月

总成本：约 $126/月
```

## 六、实现示例

### 6.1 AI 分析服务
```typescript
class AIAnalyzer {
  async analyze(error: ErrorData): Promise<AIAnalysisResult> {
    // 1. 检查缓存
    const cached = await this.checkCache(error)
    if (cached) return cached

    // 2. 向量检索相似错误
    const similar = await this.findSimilar(error)
    if (similar && similar.score > 0.85) {
      return similar.analysis
    }

    // 3. 调用 AI 分析
    const analysis = await this.callAI(error)

    // 4. 存储结果
    await this.saveAnalysis(error, analysis)

    return analysis
  }

  private async callAI(error: ErrorData) {
    const response = await anthropic.messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: 2000,
      messages: [{
        role: 'user',
        content: this.buildPrompt(error)
      }]
    })

    return this.parseResponse(response)
  }
}
```

### 6.2 向量检索服务
```typescript
class VectorSearchService {
  async findSimilar(error: ErrorData) {
    // 1. 生成 embedding
    const embedding = await this.embed(error)

    // 2. 向量检索
    const results = await pinecone.query({
      vector: embedding,
      topK: 5,
      includeMetadata: true
    })

    // 3. 返回最相似的
    return results.matches[0]
  }

  private async embed(error: ErrorData) {
    const text = this.buildEmbeddingText(error)
    const response = await openai.embeddings.create({
      model: 'text-embedding-3-small',
      input: text
    })
    return response.data[0].embedding
  }
}
```

## 七、效果评估

### 7.1 评估指标
- **准确率**：AI 分析的准确性
- **覆盖率**：能够分析的错误比例
- **响应时间**：分析耗时
- **成本效益**：单次分析成本

### 7.2 持续优化
- 收集用户反馈
- 优化 Prompt
- 调整触发策略
- 更新缓存策略
