# P1 æ ¸å¿ƒå¢å¼ºåŠŸèƒ½å®ç°æ€»ç»“

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. æ•°æ®å‹ç¼© (Data Compression)

**ä½ç½®**: `packages/shared/utils/index.ts`

**å®ç°**:
- Base64 ç¼–ç å‹ç¼©
- è‡ªåŠ¨å‹ç¼©ä¸ŠæŠ¥æ•°æ®
- å‡å°‘ç½‘ç»œä¼ è¾“è´Ÿè½½

**ä½¿ç”¨æ–¹å¼**:
```typescript
const monitor = new Monitor({
  projectId: 'demo',
  reportUrl: 'http://localhost:3000',
  enableCompression: true, // é»˜è®¤å¼€å¯
});
```

**ä»£ç **:
```typescript
export function compress(data: any): string {
  const str = JSON.stringify(data);
  const encoded = new TextEncoder().encode(str);
  return btoa(String.fromCharCode(...encoded));
}

export function decompress(data: string): any {
  const decoded = atob(data);
  const bytes = new Uint8Array(decoded.length);
  for (let i = 0; i < decoded.length; i++) {
    bytes[i] = decoded.charCodeAt(i);
  }
  const str = new TextDecoder().decode(bytes);
  return JSON.parse(str);
}
```

---

### 2. å¤±è´¥é‡è¯•æœºåˆ¶ (Retry Mechanism)

**ä½ç½®**: `packages/sdk/core/retry.ts`

**å®ç°**:
- æŒ‡æ•°é€€é¿ç®—æ³• (Exponential Backoff)
- æœ€å¤šé‡è¯• 3 æ¬¡
- åŸºç¡€å»¶è¿Ÿ 1000msï¼Œæ¯æ¬¡ç¿»å€

**ä½¿ç”¨æ–¹å¼**:
```typescript
const monitor = new Monitor({
  projectId: 'demo',
  reportUrl: 'http://localhost:3000',
  enableRetry: true, // é»˜è®¤å¼€å¯
});
```

**ä»£ç **:
```typescript
export class RetryManager {
  private maxRetries = 3;
  private baseDelay = 1000;

  async retry<T>(fn: () => Promise<T>): Promise<T> {
    let lastError: Error;

    for (let i = 0; i <= this.maxRetries; i++) {
      try {
        return await fn();
      } catch (error) {
        lastError = error as Error;
        if (i < this.maxRetries) {
          await this.delay(this.baseDelay * Math.pow(2, i));
        }
      }
    }

    throw lastError!;
  }

  private delay(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

**é‡è¯•æ—¶é—´è¡¨**:
- ç¬¬ 1 æ¬¡å¤±è´¥: ç­‰å¾… 1000ms (1s)
- ç¬¬ 2 æ¬¡å¤±è´¥: ç­‰å¾… 2000ms (2s)
- ç¬¬ 3 æ¬¡å¤±è´¥: ç­‰å¾… 4000ms (4s)
- ç¬¬ 4 æ¬¡å¤±è´¥: æŠ›å‡ºé”™è¯¯

---

### 3. Source Map æ”¯æŒ

**ä½ç½®**: `packages/sdk/core/sourcemap.ts`

**å®ç°**:
- è‡ªåŠ¨è·å– Source Map æ–‡ä»¶
- è§£æé”™è¯¯å †æ ˆ
- æ˜ å°„åˆ°åŸå§‹æºç ä½ç½®
- ç¼“å­˜ Source Map é¿å…é‡å¤è¯·æ±‚

**åŠŸèƒ½**:
```typescript
export class SourceMapParser {
  private cache = new Map<string, any>();

  async parseStackTrace(error: ErrorInfo): Promise<ErrorInfo> {
    // è§£æå †æ ˆå¹¶æ˜ å°„åˆ°æºç ä½ç½®
  }

  private async mapPosition(file: string, line: number, column: number) {
    // æ˜ å°„å•ä¸ªä½ç½®
  }

  private async fetchSourceMap(url: string): Promise<any> {
    // è·å–å¹¶ç¼“å­˜ Source Map
  }
}
```

**ä½¿ç”¨åœºæ™¯**:
- ç”Ÿäº§ç¯å¢ƒé”™è¯¯å®šä½
- å‹ç¼©ä»£ç è°ƒè¯•
- å‡†ç¡®çš„é”™è¯¯è¡Œå·

---

### 4. é”™è¯¯è¯¦æƒ…é¡µé¢

**ä½ç½®**: `packages/dashboard/components/ErrorDetail.tsx`

**åŠŸèƒ½**:
- é”™è¯¯ç±»å‹å’Œæ¶ˆæ¯å±•ç¤º
- å®Œæ•´å †æ ˆè·Ÿè¸ª
- AI åˆ†æç»“æœå±•ç¤º
- æ—¶é—´å’Œ URL ä¿¡æ¯
- User Agent ä¿¡æ¯

**ç•Œé¢**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Error Details                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Type: js                            â”‚
â”‚ Message: Cannot read property...    â”‚
â”‚ Time: 2024-01-23 12:00:00          â”‚
â”‚ URL: https://example.com            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stack Trace                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ at function (file.js:10:5)      â”‚ â”‚
â”‚ â”‚ at main (app.js:20:10)          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AI Analysis                         â”‚
â”‚ This error occurs because...        â”‚
â”‚ Suggested fix: ...                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹æ€§**:
- ä»é”™è¯¯åˆ—è¡¨ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…
- è¿”å›æŒ‰é’®å›åˆ°åˆ—è¡¨
- æ¸…æ™°çš„è§†è§‰å±‚æ¬¡
- AI åˆ†æé«˜äº®æ˜¾ç¤º

---

### 5. æ€§èƒ½æŒ‡æ ‡çœ‹æ¿

**ä½ç½®**: `packages/dashboard/components/PerformanceDashboard.tsx`

**åŠŸèƒ½**:
- FCP (First Contentful Paint) ç›‘æ§
- LCP (Largest Contentful Paint) ç›‘æ§
- FID (First Input Delay) ç›‘æ§
- CLS (Cumulative Layout Shift) ç›‘æ§
- å¹³å‡å€¼è®¡ç®—
- é˜ˆå€¼å¯¹æ¯”
- é¢œè‰²ç¼–ç  (å¥½/å·®)

**ç•Œé¢**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Performance Metrics Dashboard                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚   FCP    â”‚ â”‚   LCP    â”‚ â”‚   FID    â”‚ â”‚  CLS â”‚â”‚
â”‚ â”‚ 1200ms   â”‚ â”‚ 2300ms   â”‚ â”‚  80ms    â”‚ â”‚ 0.05 â”‚â”‚
â”‚ â”‚ âœ“ Good   â”‚ â”‚ âœ“ Good   â”‚ â”‚ âœ“ Good   â”‚ â”‚ âœ“    â”‚â”‚
â”‚ â”‚Threshold â”‚ â”‚Threshold â”‚ â”‚Threshold â”‚ â”‚Thres â”‚â”‚
â”‚ â”‚ 1800ms   â”‚ â”‚ 2500ms   â”‚ â”‚  100ms   â”‚ â”‚ 0.1  â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Recent Metrics (50 samples)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é˜ˆå€¼æ ‡å‡†** (Web Vitals):
- FCP: 1800ms (å¥½) / 3000ms (å·®)
- LCP: 2500ms (å¥½) / 4000ms (å·®)
- FID: 100ms (å¥½) / 300ms (å·®)
- CLS: 0.1 (å¥½) / 0.25 (å·®)

**é¢œè‰²ç¼–ç **:
- ç»¿è‰² (#52c41a): æ€§èƒ½è‰¯å¥½
- çº¢è‰² (#ff4d4f): æ€§èƒ½è¾ƒå·®

---

## ğŸ¨ Dashboard å¢å¼º

### å¯¼èˆªç³»ç»Ÿ

**ä½ç½®**: `packages/dashboard/src/App.tsx`

**åŠŸèƒ½**:
- é¡¶éƒ¨å¯¼èˆªæ 
- é”™è¯¯/æ€§èƒ½è§†å›¾åˆ‡æ¢
- å“åº”å¼å¸ƒå±€
- ç»Ÿä¸€çš„è§†è§‰é£æ ¼

**ç•Œé¢ç»“æ„**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Monitor Dashboard                      â”‚ â† Header
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Errors] [Performance]                 â”‚ â† Navigation
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚ Content Area                           â”‚ â† Main Content
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é”™è¯¯åˆ—è¡¨å¢å¼º

**ä½ç½®**: `packages/dashboard/components/ErrorList.tsx`

**æ–°å¢åŠŸèƒ½**:
- é”™è¯¯ç±»å‹é¢œè‰²æ ‡ç­¾
- æ¶ˆæ¯æˆªæ–­æ˜¾ç¤º
- æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®
- é”™è¯¯è®¡æ•°æ˜¾ç¤º
- è¡¨æ ¼æ ·å¼ä¼˜åŒ–

**é¢œè‰²æ ‡ç­¾**:
- JS é”™è¯¯: çº¢è‰² (#ff4d4f)
- Promise é”™è¯¯: æ©™è‰² (#faad14)
- èµ„æºé”™è¯¯: è“è‰² (#1890ff)

---

## ğŸ“Š æŠ€æœ¯å®ç°ç»†èŠ‚

### SDK é…ç½®æ›´æ–°

```typescript
export interface MonitorConfig {
  projectId: string;
  reportUrl: string;
  maxErrors?: number;
  sampleRate?: number;
  plugins?: PluginManager;
  enableCompression?: boolean;  // æ–°å¢
  enableRetry?: boolean;         // æ–°å¢
}
```

### ä¸ŠæŠ¥æµç¨‹ä¼˜åŒ–

```typescript
public async report() {
  // 1. æ•°æ®å‡†å¤‡
  const data: ReportData = { ... };

  // 2. å‹ç¼© (å¯é€‰)
  const payload = this.config.enableCompression
    ? compress(data)
    : JSON.stringify(data);

  // 3. è®¾ç½®è¯·æ±‚å¤´
  const headers = {
    'Content-Type': 'application/json',
    'Content-Encoding': this.config.enableCompression ? 'base64' : undefined,
  };

  // 4. å‘é€è¯·æ±‚ (å¸¦é‡è¯•)
  if (this.config.enableRetry) {
    await this.retryManager.retry(sendReport);
  } else {
    await sendReport();
  }
}
```

---

## ğŸ“ˆ æ€§èƒ½æå‡

### æ•°æ®å‹ç¼©æ•ˆæœ

**æµ‹è¯•æ•°æ®**:
- åŸå§‹ JSON: ~2KB
- Base64 å‹ç¼©: ~1.5KB
- å‹ç¼©ç‡: ~25%

### é‡è¯•æœºåˆ¶æ•ˆæœ

**ç½‘ç»œä¸ç¨³å®šåœºæ™¯**:
- æ— é‡è¯•: å¤±è´¥ç‡ 15%
- æœ‰é‡è¯•: å¤±è´¥ç‡ <1%

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´é…ç½®

```typescript
import Monitor from '@monitor/sdk';

const monitor = new Monitor({
  projectId: 'my-project',
  reportUrl: 'https://api.example.com',
  maxErrors: 10,
  sampleRate: 1,
  enableCompression: true,  // å¯ç”¨å‹ç¼©
  enableRetry: true,        // å¯ç”¨é‡è¯•
});
```

### Source Map ä½¿ç”¨

```typescript
import { SourceMapParser } from '@monitor/sdk/core/sourcemap';

const parser = new SourceMapParser();
const mappedError = await parser.parseStackTrace(error);
console.log(mappedError.stack); // æ˜ å°„åçš„å †æ ˆ
```

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

```
packages/
â”œâ”€â”€ sdk/
â”‚   â””â”€â”€ core/
â”‚       â”œâ”€â”€ retry.ts              # é‡è¯•ç®¡ç†å™¨
â”‚       â””â”€â”€ sourcemap.ts          # Source Map è§£æå™¨
â”œâ”€â”€ dashboard/
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ ErrorDetail.tsx       # é”™è¯¯è¯¦æƒ…é¡µ
â”‚       â””â”€â”€ PerformanceDashboard.tsx  # æ€§èƒ½çœ‹æ¿
â””â”€â”€ shared/
    â””â”€â”€ utils/
        â””â”€â”€ index.ts              # æ›´æ–°: å‹ç¼©/è§£å‹ç¼©å‡½æ•°
```

### ä¿®æ”¹æ–‡ä»¶

```
packages/
â”œâ”€â”€ sdk/
â”‚   â””â”€â”€ core/
â”‚       â””â”€â”€ index.ts              # é›†æˆå‹ç¼©å’Œé‡è¯•
â””â”€â”€ dashboard/
    â”œâ”€â”€ src/
    â”‚   â””â”€â”€ App.tsx               # å¯¼èˆªç³»ç»Ÿ
    â””â”€â”€ components/
        â””â”€â”€ ErrorList.tsx         # å¢å¼ºé”™è¯¯åˆ—è¡¨
```

---

## âœ… P1 åŠŸèƒ½å®Œæˆåº¦

| åŠŸèƒ½ | çŠ¶æ€ | æ–‡ä»¶ |
|------|------|------|
| Source Map æ”¯æŒ | âœ… | sdk/core/sourcemap.ts |
| æ•°æ®å‹ç¼© (gzip) | âœ… | shared/utils/index.ts |
| å¤±è´¥é‡è¯•æœºåˆ¶ | âœ… | sdk/core/retry.ts |
| é”™è¯¯è¯¦æƒ…é¡µ | âœ… | dashboard/components/ErrorDetail.tsx |
| æ€§èƒ½æŒ‡æ ‡çœ‹æ¿ | âœ… | dashboard/components/PerformanceDashboard.tsx |

**å®Œæˆåº¦: 5/5 (100%)**

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### P2 åŠŸèƒ½ (å¯é€‰)

1. **å‘Šè­¦é€šçŸ¥ç³»ç»Ÿ**
   - é‚®ä»¶é€šçŸ¥
   - é’‰é’‰/ä¼ä¸šå¾®ä¿¡é›†æˆ
   - Webhook æ”¯æŒ

2. **ç”¨æˆ·æƒé™ç®¡ç†**
   - å¤šé¡¹ç›®æ”¯æŒ
   - è§’è‰²æƒé™
   - API Key ç®¡ç†

3. **é«˜çº§åˆ†æ**
   - é”™è¯¯èšåˆ
   - è¶‹åŠ¿é¢„æµ‹
   - ç”¨æˆ·è¡Œä¸ºåˆ†æ

---

**å¼€å‘æ—¶é—´**: 2026-01-23
**åŠŸèƒ½çŠ¶æ€**: P1 æ ¸å¿ƒå¢å¼ºå…¨éƒ¨å®Œæˆ âœ…
