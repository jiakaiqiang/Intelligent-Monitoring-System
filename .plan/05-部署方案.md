# 部署方案

## 一、部署架构

### 1.1 整体架构
```
┌─────────────────────────────────────────────────────────┐
│                      CDN (CloudFlare)                    │
│                    ↓ SDK 静态资源                         │
├─────────────────────────────────────────────────────────┤
│                   负载均衡 (ALB/Nginx)                    │
│                    ↓ 流量分发                            │
├─────────────────────────────────────────────────────────┤
│  API 服务集群          │    Dashboard 前端               │
│  (Docker + K8s)       │    (Vercel/Netlify)            │
├─────────────────────────────────────────────────────────┤
│  Redis 集群           │    MongoDB 集群                 │
│  (缓存/队列)          │    (数据存储)                    │
├─────────────────────────────────────────────────────────┤
│  向量数据库            │    对象存储                      │
│  (Pinecone)          │    (S3/OSS)                     │
└─────────────────────────────────────────────────────────┘
```

### 1.2 服务拆分
- **SDK 服务**：CDN 分发
- **API 服务**：容器化部署
- **Dashboard**：静态托管
- **数据库**：托管服务
- **AI 服务**：Serverless

## 二、环境规划

### 2.1 环境划分

#### 开发环境 (Dev)
```yaml
purpose: 开发测试
resources:
  api: 1 实例 (1 Core, 2GB)
  redis: 单机
  mongodb: 单机
  domain: dev.monitor.example.com
```

#### 预发布环境 (Staging)
```yaml
purpose: 上线前验证
resources:
  api: 2 实例 (2 Core, 4GB)
  redis: 主从
  mongodb: 副本集
  domain: staging.monitor.example.com
```

#### 生产环境 (Production)
```yaml
purpose: 正式服务
resources:
  api: 3+ 实例 (4 Core, 8GB)
  redis: 集群模式
  mongodb: 分片集群
  domain: monitor.example.com
```

### 2.2 环境变量管理
```bash
# .env.example
NODE_ENV=production
PORT=3000

# 数据库
MONGODB_URI=mongodb://localhost:27017/monitor
REDIS_URL=redis://localhost:6379

# AI 服务
ANTHROPIC_API_KEY=sk-xxx
OPENAI_API_KEY=sk-xxx
PINECONE_API_KEY=xxx

# 对象存储
AWS_ACCESS_KEY_ID=xxx
AWS_SECRET_ACCESS_KEY=xxx
S3_BUCKET=monitor-storage

# 告警通知
SMTP_HOST=smtp.example.com
SMTP_PORT=587
WEBHOOK_URL=https://hooks.example.com
```

## 三、容器化部署

### 3.1 Dockerfile

#### API 服务
```dockerfile
# packages/server/Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app
COPY package*.json pnpm-lock.yaml ./
RUN npm install -g pnpm && pnpm install --frozen-lockfile

COPY . .
RUN pnpm build

FROM node:20-alpine
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
COPY package.json ./

EXPOSE 3000
CMD ["node", "dist/index.js"]
```

#### Dashboard
```dockerfile
# packages/dashboard/Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app
COPY package*.json pnpm-lock.yaml ./
RUN npm install -g pnpm && pnpm install --frozen-lockfile

COPY . .
RUN pnpm build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
```

### 3.2 Docker Compose
```yaml
# docker-compose.yml
version: '3.8'

services:
  api:
    build: ./packages/server
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - MONGODB_URI=mongodb://mongo:27017/monitor
      - REDIS_URL=redis://redis:6379
    depends_on:
      - mongo
      - redis
    restart: unless-stopped

  dashboard:
    build: ./packages/dashboard
    ports:
      - "80:80"
    depends_on:
      - api
    restart: unless-stopped

  mongo:
    image: mongo:7
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped

volumes:
  mongo-data:
  redis-data:
```

## 四、Kubernetes 部署

### 4.1 API 服务部署
```yaml
# k8s/api-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: monitor-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: monitor-api
  template:
    metadata:
      labels:
        app: monitor-api
    spec:
      containers:
      - name: api
        image: monitor/api:latest
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
        - name: MONGODB_URI
          valueFrom:
            secretKeyRef:
              name: monitor-secrets
              key: mongodb-uri
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 3000
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: monitor-api-service
spec:
  selector:
    app: monitor-api
  ports:
  - protocol: TCP
    port: 80
    targetPort: 3000
  type: LoadBalancer
```

### 4.2 HPA 自动扩缩容
```yaml
# k8s/api-hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: monitor-api-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: monitor-api
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

### 4.3 ConfigMap 和 Secret
```yaml
# k8s/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: monitor-config
data:
  NODE_ENV: "production"
  PORT: "3000"
  LOG_LEVEL: "info"
---
# k8s/secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: monitor-secrets
type: Opaque
data:
  mongodb-uri: <base64-encoded>
  redis-url: <base64-encoded>
  anthropic-api-key: <base64-encoded>
```

## 五、数据库部署

### 5.1 MongoDB 部署

#### 副本集配置
```yaml
# MongoDB 副本集
replication:
  replSetName: "monitor-rs"

# 分片配置（可选）
sharding:
  clusterRole: shardsvr
```

#### 索引创建
```javascript
// 错误数据索引
db.errors.createIndex({ projectId: 1, timestamp: -1 })
db.errors.createIndex({ errorType: 1, timestamp: -1 })
db.errors.createIndex({ userId: 1, timestamp: -1 })

// 复合索引
db.errors.createIndex({
  projectId: 1,
  errorType: 1,
  timestamp: -1
})
```

### 5.2 Redis 部署

#### 集群模式
```bash
# Redis 集群配置
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
appendonly yes
```

#### 持久化配置
```bash
# RDB + AOF 混合持久化
save 900 1
save 300 10
save 60 10000
appendonly yes
appendfsync everysec
```

## 六、CI/CD 流程

### 6.1 GitHub Actions
```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Run tests
        run: pnpm test

      - name: Build
        run: pnpm build

      - name: Build Docker images
        run: |
          docker build -t monitor/api:${{ github.sha }} ./packages/server
          docker build -t monitor/dashboard:${{ github.sha }} ./packages/dashboard

      - name: Push to registry
        run: |
          docker push monitor/api:${{ github.sha }}
          docker push monitor/dashboard:${{ github.sha }}

      - name: Deploy to K8s
        run: |
          kubectl set image deployment/monitor-api api=monitor/api:${{ github.sha }}
          kubectl rollout status deployment/monitor-api
```

### 6.2 发布流程
```bash
# 1. 版本管理（使用 Changesets）
pnpm changeset

# 2. 版本升级
pnpm changeset version

# 3. 构建
pnpm build

# 4. 发布到 npm
pnpm changeset publish

# 5. 部署到生产环境
pnpm deploy:prod
```

## 七、监控和日志

### 7.1 应用监控

#### Prometheus + Grafana
```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'monitor-api'
    static_configs:
      - targets: ['api:3000']
    metrics_path: '/metrics'
```

#### 关键指标
- API 请求量和响应时间
- 错误率
- 数据库连接数
- Redis 命中率
- 队列长度

### 7.2 日志管理

#### ELK Stack
```yaml
# filebeat.yml
filebeat.inputs:
  - type: container
    paths:
      - '/var/lib/docker/containers/*/*.log'

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
```

#### 日志格式
```typescript
// 结构化日志
{
  timestamp: '2024-01-23T10:00:00Z',
  level: 'error',
  service: 'monitor-api',
  message: 'Database connection failed',
  context: {
    userId: 'xxx',
    requestId: 'xxx'
  }
}
```

### 7.3 告警配置

#### Prometheus 告警规则
```yaml
# alerts.yml
groups:
  - name: monitor-alerts
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        annotations:
          summary: "High error rate detected"

      - alert: HighMemoryUsage
        expr: container_memory_usage_bytes / container_spec_memory_limit_bytes > 0.9
        for: 5m
        annotations:
          summary: "High memory usage"
```

## 八、备份和恢复

### 8.1 数据备份

#### MongoDB 备份
```bash
# 每日备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d)
mongodump --uri="$MONGODB_URI" --out="/backup/mongo-$DATE"
aws s3 cp "/backup/mongo-$DATE" "s3://backups/mongo-$DATE" --recursive
```

#### Redis 备份
```bash
# RDB 快照备份
redis-cli --rdb /backup/dump.rdb
aws s3 cp /backup/dump.rdb s3://backups/redis/dump-$(date +%Y%m%d).rdb
```

### 8.2 灾难恢复

#### 恢复流程
1. 从 S3 下载最新备份
2. 恢复数据库
3. 验证数据完整性
4. 切换流量

## 九、安全加固

### 9.1 网络安全
- 使用 HTTPS/TLS
- 配置 CORS
- 限流和防 DDoS
- WAF 防护

### 9.2 数据安全
- 敏感数据加密
- API Key 轮换
- 访问控制（RBAC）
- 审计日志

### 9.3 容器安全
```dockerfile
# 使用非 root 用户
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nodejs -u 1001
USER nodejs

# 最小化镜像
FROM node:20-alpine
```

## 十、成本估算

### 10.1 月度成本（1000 万 PV）

#### 云服务器（AWS）
- API 服务：3 x t3.large = $150
- 负载均衡：ALB = $30
- 总计：$180

#### 数据库
- MongoDB Atlas M30 = $300
- Redis ElastiCache = $100
- 总计：$400

#### 存储和 CDN
- S3 存储：100GB = $3
- CloudFront CDN = $50
- 总计：$53

#### AI 服务
- Claude API = $56
- Pinecone = $70
- 总计：$126

#### 总成本：约 $759/月

### 10.2 成本优化建议
- 使用预留实例（节省 30-50%）
- 启用自动扩缩容
- 优化数据库查询
- CDN 缓存优化
- AI 调用控制
